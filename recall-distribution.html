<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="utf-8" />

        <title>Simple DEA Drug Recall Stats</title>
        <meta name="description" content="Simple DEA Drug Recall Stats" />

        <link
            rel="stylesheet"
            href="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.css"
        />

        <script src="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.js"></script>
    </head>

    <body>
        <h1></h1>

        <div class="chart"></dev>

        <!-- <script src="state-names.js" type="module"></script> -->
        <script type="module">
            import {states} from './state-names.js';

            const chartService = () => {

                let currentChart;

                async function fetchData(state) {
                    let url = `https://api.fda.gov/drug/enforcement.json?search=report_date:[20180101+TO+20191231]+AND+state:${state}&limit=100`;

                    let response = await window.fetch(url);
                    return response.json();
                }

                function formatData(data) {
                    let monthData = {};

                    let formatted = data.map(item => {
                        let month = item.report_date.substring(4,6);

                        if(monthData[month] === undefined) {
                            monthData[month] = 0;
                        }

                        monthData[month]++;
                    })

                    return Object.keys(monthData).map(key => monthData[key]);
                }

                function drawChart(data, labels) {
                    currentChart = new Chartist.Bar(
                        '.chart',
                        {
                            labels: labels,
                            series: data,
                        },
                        {
                            distributeSeries: true,
                        }
                    );
                }

                return {
                    async render(state) {
                        try {
                            let data = await fetchData(state);
                            let formattedData = formatData(data.results);

                            drawChart(formattedData, this.chartLabels);
                        } catch (error) {
                            console.log('ERROR Loading Data!', data);    
                        }
                    },

                    get chartLabels() {
                        return ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
                    },
                }
            }

            const urlParams = new URLSearchParams(window.location.search);
            const state = urlParams.get('state');

            const chart = chartService();

            chart.render(state)

            document.querySelector('h1').innerHTML = `DEA Drug recall reports for ${state.toUpperCase()}`;
        </script>
    </body>
</html>
